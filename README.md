# How-to-share-emulator-from-AOSP

Android Emulator is used to run Android on the PC. Essentially, it's a virtual machine that you can get from building AOSP.

## 1. Build AOSP emulator

**NOTICE: I use android_12.0.0_r1 version of AOSP**.

```shell
# at your AOSP Home Path
> source build/envsetup.sh
> lunch sdk_phone_x86_64
> make -j32
```

It has to be noticed that **sdk_phone_x86_64** is not in the available target list of `lunch`. (`lunch` is a function defined in build/envsetup.sh) However, you can still use `sdk_phone_x86_64` as the argument of `lunch`.

After your AOSP build system finish its build process, you'll get "out" directory under your "AOSP Home Path" and have a view of:

```shell
.
└── out
    └── target
        └── product
            └── emulator_x86_64
```

And under the "emulator_x86_64", you'll see:

```shell
.
├── advancedFeatures.ini
├── android-info.txt
├── apex
├── appcompat
├── build.avd
├── build_fingerprint.txt
├── build_thumbprint.txt
├── cache
├── cache.img
├── cache.img.qcow2
├── clean_steps.mk
├── config.ini
├── data
├── debug_ramdisk
├── dexpreopt_config
├── dtb.img
├── emu-launch-params.txt
├── encryptionkey.img
├── encryptionkey.img.qcow2
├── fake_packages
├── gen
├── hardware-qemu.ini
├── initrd
├── installed-files.json
├── installed-files-product.json
├── installed-files-product.txt
├── installed-files-ramdisk-debug.json
├── installed-files-ramdisk-debug.txt
├── installed-files-ramdisk.json
├── installed-files-ramdisk.txt
├── installed-files-root.json
├── installed-files-root.txt
├── installed-files-system_ext.json
├── installed-files-system_ext.txt
├── installed-files.txt
├── installed-files-vendor.json
├── installed-files-vendor-ramdisk-debug.json
├── installed-files-vendor-ramdisk-debug.txt
├── installed-files-vendor-ramdisk.json
├── installed-files-vendor-ramdisk.txt
├── installed-files-vendor.txt
├── kernel-ranchu
├── misc_info.txt
├── modem_simulator
├── module-info.json
├── module-info.json.rsp
├── multiinstance.lock
├── obj
├── obj_x86
├── previous_build_config.mk
├── product
├── product.img
├── product-qemu.img
├── ramdisk
├── ramdisk.img
├── ramdisk-qemu.img
├── read-snapshot.txt
├── recovery
├── root
├── super_empty.img
├── super.img
├── symbols
├── system
├── system_ext
├── system_ext.img
├── system_ext-qemu.img
├── system.img
├── system-qemu-config.txt
├── system-qemu.img
├── testcases
├── test_harness_ramdisk
├── tmpAdbCmds
├── userdata.img
├── userdata-qemu.img
├── userdata-qemu.img.qcow2
├── vbmeta.img
├── vendor
├── vendor_boot-debug.img
├── vendor_boot.img
├── vendor_boot-test-harness.img
├── vendor_debug_ramdisk
├── vendor.img
├── vendor-qemu.img
├── vendor_ramdisk
├── vendor_ramdisk-debug.img
├── vendor_ramdisk.img
├── vendor_ramdisk-test-harness.img
├── VerifiedBootParams.textproto
└── version_num.cache
```

**NOTICE: I have run emulator, so some files not generated by build process might occur here**.

## 2. Extract essential files under out/

Android emulator need several image files and configuration files to enable its execute process. You can check [Boot Emulator in commandline way](https://developer.android.com/studio/run/emulator-commandline) to know some basic concepts about images. (e.g. system.img, userdata.img, userdata-qemu.img, ramdisk.img, vendor.img, encryptionkey.img)

And these files is important:

* advancedFeatures.ini          (some config)
* build.avd                     (a dir. avd used by AOSP build system)
* config.ini                    (some config)
* encryptionkey.img             (encryptionkey)
* hardware-qemu.ini             (some config)
* initrd                        (init data)
* kernel-ranchu                 (kernel v2)
* system                        (a dir)
* system.img                    (system)
* system-qemu.img               (system)
* ramdisk.img                   (ramdisk)
* ramdisk-qemu.img              (ramdisk)
* userdata.img                  (init userdata)
* userdata-qemu.img             (/data partition image file)
* vendor.img                    (vendor)
* VerifiedBootParams.textproto

It's necessary to share all the files mentioned above.

## 3. (Optional) Extract essential files under prebuilts/

You can move to Sec.4 if you don't have the whole AOSP on your machine and have an executable emulator.

In AOSP, directory prebuilts contains some lib, exe and tools that have already built. There is also an emulator in prebuilts (e.g. prebuilts/android-emulator/linux-x86_64/emulator). In addition, emulator in prebuilts need some other files to enable its work. These following files is important:

* emulator                      (executable file)
* qemu                          (qemu used is under this path)
* lib64                         (some lib qemu need)
* lib                           (some file qemu need when boot)

And then, you can use "emulator" in this folder to run, instead of emulator under Android SDK path.

## 4. Set environment variables

Actually, there is 3 modes in emulator.

* Android SDK mode: you can only download Android SDK to use emulator, instead of the whole AOSP. In this scene, you need to create a virtual device by avdmanager(in cmdline-tools). You can get more information by emulator `-help-sdk-images`.
* Android build system mode (I use): define `ANDROID_PRODUCT_OUT` and `ANDROID_BUILD_TOP`. This need you to fetch the whole AOSP. You can get more information by emulator `-help-build-images`.
* Without Android SDK and Android build system: acctually, I failed to use this mode to run emulator correctly, and this mode, I doubt, whether it is usable or not.

So use the following command:

```shell
# <your-path> means the path you want to share files about emulator.
> export ANDROID_BUILD_TOP=<your-path>
> export ANDROID_PRODUCT_OUT=<your-path>/out/target/product/emulator_x86_64/
```

Note that the current structure is:

```shell
. ("." means <your-path> above)
├── out
│   └── target
│       └── product
│           └── emulator_x86_64
│               ├── advancedFeatures.ini
│               ├── build.avd
│               ├── config.ini
│               ├── encryptionkey.img
│               ├── hardware-qemu.ini
│               ├── initrd
│               ├── kernel-ranchu
│               ├── ramdisk.img
│               ├── ramdisk-qemu.img
│               ├── system
│               ├── system.img
│               ├── system-qemu.img
│               ├── userdata.img
│               ├── userdata-qemu.img
│               ├── vendor.img
│               └── VerifiedBootParams.textproto
│
│
└── prebuilts (optional if you use emulator in AOSP/prebuilts)
    └── android-emulator
        └── linux-x86_64
            ├── emulator
            ├── lib
            ├── lib64
            └── qemu
```

## 5. Run!

```shell
# This emulator can be prebuilt/android-emulator/linux-x86_64/emulator under your AOSP,
# also can be emulator/emulator under your Android SDK.
> emulator -no-window -verbose
```

You can use adb to check device status and execute in shell:

```shell
> adb devices # to check device and its status
> adb root
> adb shell   # use shell
> adb logcat  # to check log output when emulator running
```

If you want to check whether you extract correctly, output is available [here](https://github.com/skyleaworlder/How-to-share-emulator-from-AOSP/build-system-mode-with-android-sdk-emulator.log).

```shell
# these env used in output example
> export ANDROID_PRODUCT_OUT=/home/user/aosp/out/target/product/emulator_x86_64/
> export ANDROID_BUILD_TOP=/home/user/aosp/
```
